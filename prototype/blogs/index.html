<!DOCTYPE html>
<html>

<head>
    <title>Patio Blogs Experimental</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const md = urlParams.get('md');
        function loadFile() {
            if (md) {
                document.getElementById('blog-title').style = 'display: block'
                document.getElementById('blog-title').innerHTML = `<h1>${md}</h1>`
                document.getElementById('blog-index').style = 'display: none'
                document.getElementById('blog-post').style = 'display: block'
                document.getElementById('footer-to-blog-index').style = 'display: block'
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var markdown = xhr.responseText;
                        var html = marked.parse(markdown);
                        document.getElementById('blog-post').innerHTML = html;
                    }
                };
                xhr.open('GET', `${md}.md`, true);
                xhr.send();
            } else {
                document.getElementById('blog-title').style = 'display: none'
                document.getElementById('blog-title').innerHTML = ''
                document.getElementById('blog-index').style = 'display: block'
                document.getElementById('blog-post').style = 'display: none'
                document.getElementById('footer-to-blog-index').style = 'display: none'
            }

        }
        async function fetchComments() {
            // Make a GET request to the comments REST API
            const response = await fetch('https://tng.coop/p2.php');
            const comments = await response.json();
            return comments;
        }

        async function displayComments() {
            // Get the grid container element
            const gridContainer = document.querySelector('.grid-container');

            // Retrieve the comments from the REST API
            const comments = await fetchComments();

            // Loop through each comment and add it to the grid container
            comments.forEach(comment => {
                const gridItem = document.createElement('div');
                gridItem.classList.add('grid-item');

                const username = document.createElement('h3');
                username.textContent = comment.username;

                const content = document.createElement('p');
                content.textContent = comment.content;

                const date = document.createElement('p');
                date.classList.add('date');
                date.textContent = new Date(comment.created_at).toLocaleString();

                gridItem.appendChild(username);
                gridItem.appendChild(content);
                gridItem.appendChild(date);

                // gridContainer.appendChild(gridItem);
            });
        }

        function submitForm(event) {
            event.preventDefault()
            // Get the form data
            const postId = md
            const username = document.getElementById('name').value;
            const content = document.getElementById('comment').value;

            // Create a JSON object with the form data
            const formData = {
                post_id: postId,
                username: username,
                content: content
            };
            // Send an HTTP POST request to the backend endpoint
            fetch('https://tng.coop/p.php', {
                method: 'POST',
                body: JSON.stringify(formData),
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    // If the response is OK, show a success message
                    alert('Comment submitted successfully!');
                } else {
                    // If there is an error, show an error message
                    alert('Error submitting comment. Please try again later.');
                }
            }).catch(error => {
                // alert(JSON.stringify(error))
                // alert(JSON.stringify(event))
                // If there is an error, show an error message
                alert('Error submitting comment. Please try again later.');
            });
        }

    </script>
</head>

<body onload="loadFile(); displayComments().catch(error => console.error(error));">
    <div id="blog-index" style="display: none;">
        <h2>Patio Blogs Experimental</h2>
        <ul>
            <li><a href="?md=haskell-blog1">Blog Post 1</a></li>
        </ul>
    </div>
    <p id="blog-title" style="display: none;"></p>
    <div id="blog-post" style="display: none;"></div>
    <div class="comment-box">
        <section class="comment-section">
            <h3>Comments</h3>
            <!-- Insert any necessary HTML elements for displaying comments here -->
        </section>

        <section class="comment-form-section">
            <h3>Leave a Commen2</h3>
            <form id="comment-form" onsubmit="submitForm(event)">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>

                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>

                <label for="comment">Comment:</label>
                <textarea id="comment" name="comment" required></textarea>

                <input type="submit" value="Post Comment">
            </form>
        </section>
    </div>
    <!-- <div class="grid-container"></div> -->
    <footer id="footer-to-blog-index" style="display: none;">
        <p> * Many blog posts here are Generated by GPT partially or in full </p>
        <a href="?">Go to Blog Index</a>
    </footer>
</body>

</html>